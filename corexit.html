<style>
    body {
        margin: 1%;
    }

    #_corexitContent {
        margin: 3%;
    }

    #_corexitStatus {
        font-size: 30px;
        color: black;
        -webkit-user-select:none;
    }

    #_corexitPrev {
        font-size: 30px;
        color: black;
        -webkit-user-select:none;
    }

    #_corexitNext {
        font-size: 30px;
        color: black;
        -webkit-user-select:none;
    }

    #_corexitPanel {
        text-align:left;
        font-family:Arial,Sans;
        color: white;
        background-color: black;
        width:100%;
        height: 85%;
        overflow: hidden;
    }


    #_corexitHelpClose {
        font-size: 12px;
    }


    #_corexitHelp {
        position:absolute;
        width: 50%;
        height: 25%;
        left: 25%;
        top: 25%;
        background-color: white;
        border: 2px solid gray;
        color: black;
        font-size: 18px;
        padding: 5px;
    }

    a, a.visited {
        color: black;
        font-size:30px;
    }

    #_corexitBottom {
        color: black;
        font-size:30px;

        position:fixed;
        left: 1%;
        bottom:1%;
        width: 90%;
    }

}
</style>

<script>

    var minFrameLength = 8;

    var fontSize = 60;
    var text;
    var frames;
    var currentFrame;
    var speechEnabled = false;

    function enableSpeech(line) {
        speechEnabled = true;

        var speech = document.getElementById("_corexitSpeech");
        var speechLine = line.replace("&nbsp;", " ");
        var speechLineEncoded = encodeURIComponent(speechLine);
        var speechURL = 'http://translate.google.com/translate_tts?q=' + speechLineEncoded;
        speech.innerHTML = '<iframe src="' + speechURL + '" width="200px" height="80px"></iframe>';
    }
    
    function disableSpeech() {
        speechEnabled = false;
        var speech = document.getElementById("_corexitSpeech");
        speech.innerHTML = '';
    }

    function toggleSpeech() {
        if (speechEnabled == true) {
            disableSpeech();
        }
        else {
            enableSpeech(frames[currentFrame]);
        }
    }

    function showFrame(f) {
        disableSpeech();
        
        var content = document.getElementById("_corexitContent");
        var line = frames[f];
        content.innerHTML = line;

        var status = document.getElementById("_corexitStatus");
        status.innerHTML = (f+1) + '/' + frames.length;

        var prev = document.getElementById("_corexitPrev");
        if (f == 0) {
            prev.innerHTML = '&nbsp;';
        }
        else {
            prev.innerHTML = '<a href="#" onClick="goPrevious();">&lt;----</a>';
        }

        var next = document.getElementById("_corexitNext");
        if (f == frames.length-1) {
            next.innerHTML = '&nbsp;';
        }
        else {
            next.innerHTML = '<a href="#" onClick="goNext();">----&gt;</a>';
        }


    }

    function goPrevious() {
        if (frames.length == 0)
            return;

        currentFrame--;
        if (currentFrame < 0) currentFrame = 0;

        showFrame(currentFrame);
    }

    function goNext() {
        if (frames.length == 0)
            return;

        currentFrame++;
        if (currentFrame > frames.length-1)
            currentFrame = frames.length-1;

        showFrame(currentFrame);
    }


    function fontLarger() {
        var content = document.getElementById("_corexitContent");
        fontSize+=5;
        content.style.fontSize = fontSize + "px";
    }

    function fontSmaller() {
        var content = document.getElementById("_corexitContent");
        fontSize-=5;
        if (fontSize < 1) fontSize = 1;
        content.style.fontSize = fontSize + "px";
    }

    function corexit(response) {
        text = response.text;

        if (text.length > 0) {
            currentFrame = 0;

            var i = text.replace(/[\.\?\!]\s+/g, ".\n");

            var preframes = i.split("\n");

            var l = '';
            frames = [];
            for (j = 0; j < preframes.length; j++) {
                l = l + ' ' + preframes[j];
                if (l.length > minFrameLength) {
                    frames.push( l.trim() );
                    l = '';
                }
            }
            //last frame, remaining
            l = l.trim();
            if (l.length > 0)
                frames.push( l );

            var panel = document.getElementById("_corexitPanel");
            var content = document.getElementById("_corexitContent");

            var prev = document.getElementById("_corexitPrev");
            var next = document.getElementById("_corexitNext");

            showFrame(currentFrame);
        }
        else {
            var content = document.getElementById("_corexitContent");
            content.innerHTML = "No text selected.";
            frames = [];
        }
    }

    function onContentSpin(e) {
        var nDelta = 0;
        if (!e) { // For IE, access the global (window) event object
            e = window.event;
        }
        // cross-bowser handling of eventdata to boil-down delta (+1 or -1)
        if ( e.wheelDelta ) { // IE and Opera
            nDelta= e.wheelDelta;
            if ( window.opera ) {  // Opera has the values reversed
                nDelta= -nDelta;
            }
        }
        else if (e.detail) { // Mozilla FireFox
            nDelta= -e.detail;
        }
        if (nDelta > 0) {
            //HandleMouseSpin( 1, e.clientX, e.clientY );
            goPrevious();
        }
        if (nDelta < 0) {
            //HandleMouseSpin( -1, e.clientX, e.clientY );
            goNext();
        }
        if ( e.preventDefault ) {  // Mozilla FireFox
            e.preventDefault();
        }
        e.returnValue = false;  // cancel default action
    }
    
    function onFontSpinOver(e) {
        var font = document.getElementById("_corexitFont");
        font.style.backgroundColor = "#ddd";
    }

    function onFontSpinOut(e) {
        var font = document.getElementById("_corexitFont");
        font.style.backgroundColor = "white";
    }

    //TODO find a way to combine with previous function
    function onFontSpin(e) {
        var nDelta = 0;
        if (!e) { // For IE, access the global (window) event object
            e = window.event;
        }
        // cross-bowser handling of eventdata to boil-down delta (+1 or -1)
        if ( e.wheelDelta ) { // IE and Opera
            nDelta= e.wheelDelta;
            if ( window.opera ) {  // Opera has the values reversed
                nDelta= -nDelta;
            }
        }
        else if (e.detail) { // Mozilla FireFox
            nDelta= -e.detail;
        }
        if (nDelta > 0) {
            //HandleMouseSpin( 1, e.clientX, e.clientY );
            fontLarger();
        }
        if (nDelta < 0) {
            //HandleMouseSpin( -1, e.clientX, e.clientY );
            fontSmaller();
        }
        if ( e.preventDefault ) {  // Mozilla FireFox
            e.preventDefault();
        }
        e.returnValue = false;  // cancel default action
    }

//    var skipNextSizeStore = true;

//    function restoreWindowPosition() {
//        chrome.windows.getCurrent(function(w) {
//            var l = localStorage["windowDimensions"];
//            alert('restore: ' + l);
//            if (l != undefined) {
//                w.moveTo(l[0], l[1]);
////                w.left = l[0];
////                w.top = l[1];
//                w.width = l[2];
//                w.height = l[3];
//            }
//            skipNextSizeStore = true;
//        });
//    }
    
//    function storeWindowPosition() {
//        chrome.windows.getCurrent(function(w) {
//            localStorage["windowDimensions"] = [ w.left, w.top, w.width, w.height ];
//            alert('store: ' + localStorage["windowDimensions"]);
//        });
//    }
//
    function closeWindow(event) {
        if (event.button != 0) {
            //Try both methods of hiding it
//            storeWindowPosition();
            window.close();
            document.getElementById('_corexitOverlay').style.display='none';
        }
    }


    function setup() {
        var panel = document.getElementById("_corexitPanel");
        var control = document.getElementById("_corexitControl");
        var content = document.getElementById("_corexitContent");
        var font = document.getElementById("_corexitFont");

        if (panel.addEventListener) {
            panel.addEventListener('DOMMouseScroll', onContentSpin, false);
            panel.addEventListener('mousewheel', onContentSpin, false); // Chrome
        }
        else {
            panel.onmousewheel= onpanelSpin;
        }

        if (font.addEventListener) {
            font.addEventListener('DOMMouseScroll', onFontSpin, false);
            font.addEventListener('mousewheel', onFontSpin, false); // Chrome
            font.addEventListener('mouseover', onFontSpinOver, false); // Chrome
            font.addEventListener('mouseout', onFontSpinOut, false); // Chrome
        }
        else {
            font.onmousewheel= onFontSpin;
        }

        content.style.fontSize = fontSize + "px";

        control.onclick = closeWindow;
        
        if (localStorage["hideHelp"] == 1) {
            hideHelp();
        }
        else {
            showHelp();
        }

//        window.onresize = function() {
//            if (!skipNextSizeStore) {
//                storeWindowPosition();
//            }
//            else {
//                skipNextSizeStore = false;
//            }
//        };

        //storeWindowPosition();

        chrome.extension.sendRequest({'command' : 'getText'}, corexit);

    }

    var helpShowing = false;

    function toggleHelp() {
        if (helpShowing) {
            hideHelp();
        }
        else {
            showHelp();
        }
    }

    function hideHelp() {
        helpShowing = false;
        var help = document.getElementById("_corexitHelp");
        help.style.display = 'none';
        localStorage["hideHelp"] = 1;
    }
    
    function showHelp() {
        helpShowing = true;
        var help = document.getElementById("_corexitHelp");
        help.style.display = '';
        localStorage["hideHelp"] = 0;
    }

    //Setup escape-key events
    document.onkeydown = function(e){
        var keycode;
        if (e == null) { // ie
            keycode = event.keyCode;
        } else { // mozilla
            keycode = e.which;
        }
        if(keycode == 27){ // escape, close box, esc
            window.close();
        }
        else if (keycode == 37) {
            //left
            goPrevious();
        }
        else if (keycode == 38) {
            //up
            fontLarger();
        }
        else if (keycode == 39) {
            //right
            goNext();
        }
        else if (keycode == 40) {
            //down
            fontSmaller();
        }
    };

</script>

<body onload="setup();">
    <table width="100%" id="_corexitControl" onmouseover="this.style.cursor='crosshair';" oncontextmenu="closeWindow(this); return false;">
        <tr>
            <td width="33%" align="left" id="_corexitPrev">

            </td>
            <td width="33%" align="center" id="_corexitStatus">

            </td>
            <td width="33%" align="right" id="_corexitNext">

            </td>
        </tr>
    </table>

    <div id="_corexitPanel">
        <div id="_corexitContent" style="overflow: hidden">
        </div>
    </div>

    <div id="_corexitBottom">
        <a href="#" onclick="fontSmaller()">[-]</a>
        <span id="_corexitFont">&nbsp; Abc &nbsp;</span>
        <a href="#" onclick="fontLarger()">[+]</a>
        
        <a href="#" onclick="toggleSpeech()">[Speak]</a>

        <a href="#" onclick="alert('Not implemented yet: Toggles display of images from image searches');">
                [Images]
        </a>

        <a href="#" onclick="alert('Not implemented yet: Provides a way to edit the frame, then tweets it.');">
                [Tweet...]
        </a>
        <a href="#" onclick="toggleHelp()">[?]</a>
        
        <span id="_corexitSpeech" style="float: right; width: 150px; height: 40px; overflow: hidden;">
        </span>

    </div>
    
    <div id="_corexitHelp">
        <h1>Controls</h1>
        <b>To navigate:</b> Mousewheel on center area, or hit left/right<br/>
        <b>To close:</b> Right click the top area, or hit escape<br/>
        <b>To adjust font size:</b> Mousewheel on bottom 'Abc' or click +/- buttons nearby.<br/>
        <a href='#' onclick='hideHelp()' id='_corexitHelpClose'><b>[Hide]</b></a>
    </div>



</body>