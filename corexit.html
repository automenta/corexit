<style>
    body {
        margin: 1%;
    }

    a, a.visited {
        color: black;
        font-size:30px;
    }

    #_corexitContent {
        margin: 1%;
    }

    #_corexitStatus {
        font-size: 30px;
        color: black;
        -webkit-user-select:none;
    }

    #_corexitPrev {
        font-size: 30px;
        color: black;
        -webkit-user-select:none;
    }

    #_corexitNext {
        font-size: 30px;
        color: black;
        -webkit-user-select:none;
    }

</style>

<script>

    var minFrameLength = 8;

    var fontSize = 60;
    var text;
    var frames;
    var currentFrame;

    function showFrame(f) {
        var content = document.getElementById("_corexitContent");
        content.innerHTML = frames[f];

        var status = document.getElementById("_corexitStatus");
        status.innerHTML = (f+1) + '/' + frames.length;

        var prev = document.getElementById("_corexitPrev");
        if (f == 0) {
            prev.innerHTML = '&nbsp;';
        }
        else {
            prev.innerHTML = '<a href="#" onClick="goPrevious();">&lt;----</a>';
        }

        var next = document.getElementById("_corexitNext");
        if (f == frames.length-1) {
            next.innerHTML = '&nbsp;';
        }
        else {
            next.innerHTML = '<a href="#" onClick="goNext();">----&gt;</a>';
        }

    }

    function goPrevious() {
        currentFrame--;
        if (currentFrame < 0) currentFrame = 0;

        showFrame(currentFrame);
    }

    function goNext() {
        currentFrame++;
        if (currentFrame > frames.length-1)
            currentFrame = frames.length-1;

        showFrame(currentFrame);
    }


    function fontLarger() {
        var content = document.getElementById("_corexitContent");
        fontSize+=5;
        content.style.fontSize = fontSize + "px";
    }

    function fontSmaller() {
        var content = document.getElementById("_corexitContent");
        fontSize-=5;
        if (fontSize < 1) fontSize = 1;
        content.style.fontSize = fontSize + "px";
    }

    function corexit(response) {
        text = response.text;

        if (text.length > 0) {
            currentFrame = 0;

            var i = text.replace(/[\.\?\!]\s+/g, ".\n");

            var preframes = i.split("\n");

            var l = '';
            frames = [];
            for (j = 0; j < preframes.length; j++) {
                l = l + ' ' + preframes[j];
                if (l.length > minFrameLength) {
                    frames.push( l.trim() );
                    l = '';
                }
            }
            //last frame, remaining
            l = l.trim();
            if (l.length > 0)
                frames.push( l );

            var panel = document.getElementById("_corexitPanel");
            var content = document.getElementById("_corexitContent");

            var prev = document.getElementById("_corexitPrev");
            var next = document.getElementById("_corexitNext");

            showFrame(currentFrame);
        }
        else {
            var content = document.getElementById("_corexitContent");
            content.innerHTML = "No text selected.";
        }
    }

    function onContentSpin(e) {
        var nDelta = 0;
        if (!e) { // For IE, access the global (window) event object
            e = window.event;
        }
        // cross-bowser handling of eventdata to boil-down delta (+1 or -1)
        if ( e.wheelDelta ) { // IE and Opera
            nDelta= e.wheelDelta;
            if ( window.opera ) {  // Opera has the values reversed
                nDelta= -nDelta;
            }
        }
        else if (e.detail) { // Mozilla FireFox
            nDelta= -e.detail;
        }
        if (nDelta > 0) {
            //HandleMouseSpin( 1, e.clientX, e.clientY );
            goPrevious();
        }
        if (nDelta < 0) {
            //HandleMouseSpin( -1, e.clientX, e.clientY );
            goNext();
        }
        if ( e.preventDefault ) {  // Mozilla FireFox
            e.preventDefault();
        }
        e.returnValue = false;  // cancel default action
    }

    //TODO find a way to combine with previous function
    function onFontSpin(e) {
        var nDelta = 0;
        if (!e) { // For IE, access the global (window) event object
            e = window.event;
        }
        // cross-bowser handling of eventdata to boil-down delta (+1 or -1)
        if ( e.wheelDelta ) { // IE and Opera
            nDelta= e.wheelDelta;
            if ( window.opera ) {  // Opera has the values reversed
                nDelta= -nDelta;
            }
        }
        else if (e.detail) { // Mozilla FireFox
            nDelta= -e.detail;
        }
        if (nDelta > 0) {
            //HandleMouseSpin( 1, e.clientX, e.clientY );
            fontLarger();
        }
        if (nDelta < 0) {
            //HandleMouseSpin( -1, e.clientX, e.clientY );
            fontSmaller();
        }
        if ( e.preventDefault ) {  // Mozilla FireFox
            e.preventDefault();
        }
        e.returnValue = false;  // cancel default action
    }


    function closeWindow(event) {
        if (event.button != 0)
            window.close();
    }

    function setup() {
        var panel = document.getElementById("_corexitPanel");
        var control = document.getElementById("_corexitControl");
        var content = document.getElementById("_corexitContent");
        var font = document.getElementById("_corexitFont");

        if (content.addEventListener) {
            content.addEventListener('DOMMouseScroll', onContentSpin, false);
            content.addEventListener('mousewheel', onContentSpin, false); // Chrome
        }
        else {
            content.onmousewheel= onContentSpin;
        }

        if (font.addEventListener) {
            font.addEventListener('DOMMouseScroll', onFontSpin, false);
            font.addEventListener('mousewheel', onFontSpin, false); // Chrome
        }
        else {
            font.onmousewheel= onFontSpin;
        }

        content.style.fontSize = fontSize + "px";

        control.onclick = closeWindow;

    }

    function showHelp() {
        alert("To close: Right click the top or bottom areas (when the cursor turns to cross-hairs)\n" +
            "To adjust font size: Mousewheel on bottom 'Abc' or click +/- buttons nearby."
        );
    }

    //Setup escape-key events
    document.onkeydown = function(e){
        var keycode;
        if (e == null) { // ie
            keycode = event.keyCode;
        } else { // mozilla
            keycode = e.which;
        }
        if(keycode == 27){ // escape, close box, esc
            window.close();
        }
        else if (keycode == 37) {
            //left
            goPrevious();
        }
        else if (keycode == 38) {
            //up
            fontLarger();
        }
        else if (keycode == 39) {
            //right
            goNext();
        }
        else if (keycode == 40) {
            //down
            fontSmaller();
        }
    };

    chrome.extension.sendRequest({'command' : 'getText'}, corexit);

</script>

<body onload="setup();">
    <table width="100%" id="_corexitControl" onmouseover="this.style.cursor='crosshair';" oncontextmenu="closeWindow(this); return false;">
        <tr>
            <td width="33%" align="left" id="_corexitPrev">

            </td>
            <td width="33%" align="center" id="_corexitStatus">

            </td>
            <td width="33%" align="right" id="_corexitNext">

            </td>
        </tr>
    </table>

    <div id="_corexitPanel" style="width:100%; text-align:left;background-color: gray;color:white;font-family:Arial,Sans; overflow: none">
        <div id="_corexitContent" style="height: 70%; overflow: none">
        </div>
    </div>

    <div id="_corexitBottom" width="100%">
        <a href="#" onclick="showHelp()">?</a>

        &nbsp;

        <a href="#" onclick="fontSmaller()">-</a>
        <span id="_corexitFont">Abc</span>
        <a href="#" onclick="fontLarger()">+</a>
    </div>

</body>